# GlobalLM Implementation Plan

## Project Goal

Use LLMs to automatically improve high-impact open-source software by scanning GitHub and addressing the most impactful issues, with automated PRs that can auto-merge when safe.

## Initial Scope

**Languages (5 total)**: Python, JavaScript/TypeScript, Go, Rust, Java

**Filter Threshold**: Stars > 1000 OR dependents > 100 (configurable)

---

## Architecture Overview

```
+-------------------+     +-------------------+     +-------------------+
|   Config Manager  |---->|  Repo Discoverer  |---->|  Repo Filter      |
| (thresholds.yaml) |     | (GitHub + Regs)   |     | (Health Checks)   |
+-------------------+     +-------------------+     +-------------------+
                                                           |
                                                           v
+-------------------+     +-------------------+     +-------------------+
|  PR Automation    |<----|  Issue Analyzer   |<----|  Issue Fetcher    |
| (Auto-merge)      |     | (LLM Categorizer) |     | (GitHub Issues)   |
+-------------------+     +-------------------+     +-------------------+
        ^                         |
        |                         v
+-------------------+     +-------------------+
|  Monitoring       |<----|  Solution Engine  |
| (Dashboard/Logs)  |     | (LLM Code Gen)    |
+-------------------+     +-------------------+
```

---

## Sophisticated Prioritization Algorithm

```python
PriorityScore = (HealthWeight * HealthScore) +
                (ImpactWeight * ImpactScore) +
                (SolvabilityWeight * SolvabilityScore) +
                (UrgencyWeight * UrgencyScore) -
                (ReductionFactor * RedundancyPenalty)
```

### Key Components

| Dimension | Metrics |
|-----------|---------|
| **Health** | Commit velocity, issue resolution rate, CI status, contributor diversity |
| **Impact** | PageRank, betweenness centrality, dependent count, downstream reach |
| **Solvability** | Complexity (1-10), test coverage, code size, scope, breaking risk |
| **Urgency** | Issue category (security×10, bug×5, feature×2), age, engagement |
| **Redundancy** | Functional clustering, API similarity, staleness comparison |

---

## New File Structure

```
src/globallm/
├── config/                   # NEW: Configuration management
│   ├── settings.py           # Pydantic settings models
│   ├── defaults.py           # Default configuration values
│   └── loader.py             # YAML config loading
│
├── discovery/                # NEW: Repository discovery
│   ├── repo_discoverer.py    # Multi-source repository discovery
│   ├── package_registry.py   # PyPI, npm, crates.io integration
│   └── language.py           # Language-specific discovery
│
├── filtering/                # NEW: Repository and issue filtering
│   ├── repo_filter.py        # Health-based filtering
│   ├── issue_filter.py       # Issue eligibility filtering
│   └── health_scorer.py      # Health score calculation
│
├── analysis/                 # NEW: Deep analysis components
│   ├── dependency_graph.py   # Dependency graph construction
│   ├── impact_calculator.py  # PageRank, centrality metrics
│   ├── redundancy.py         # Duplicate project detection
│   └── api_analyzer.py       # API signature extraction
│
├── issues/                   # NEW: Issue processing
│   ├── fetcher.py            # GitHub issue fetching
│   ├── analyzer.py           # LLM-based issue categorization
│   ├── prioritizer.py        # Multi-factor priority scoring
│   └── models.py             # Issue data models
│
├── solution/                 # NEW: Solution generation
│   ├── engine.py             # Main solution orchestration
│   ├── code_generator.py     # LLM code generation
│   ├── test_generator.py     # Automated test creation
│   └── validator.py          # Solution validation
│
├── automation/               # NEW: PR automation
│   ├── pr_automation.py      # PR creation and management
│   ├── auto_merge.py         # Auto-merge strategy
│   └── ci_monitor.py         # CI status monitoring
│
├── budget/                   # NEW: Budget management
│   ├── budget_manager.py     # Budget enforcement
│   ├── token_estimator.py    # Token usage estimation
│   └── state.py              # Budget state persistence
│
├── llm/                      # NEW: LLM integration layer
│   ├── base.py               # Abstract LLM interface
│   ├── claude.py             # Claude API implementation
│   ├── openai.py             # OpenAI API implementation
│   └── prompts.py            # Prompt templates
│
├── monitoring/               # NEW: Observability
│   ├── metrics.py            # Metrics collection
│   ├── dashboard.py          # CLI dashboard
│   └── reporters.py          # Report generators
│
└── models/                   # NEW: Shared data models
    ├── repository.py         # Repository models
    ├── issue.py              # Issue models
    ├── solution.py           # Solution models
    └── priority.py           # Priority scoring models

# Existing files to extend:
├── cli.py                    # Main CLI entry (extend with new commands)
├── logging_config.py         # Extend with operation IDs
└── scanner.py                # Extend with new discovery capabilities
```

---

## New Dependencies to Add

```toml
anthropic = "^0.45.0"      # Claude API
openai = "^1.57.0"         # OpenAI API
httpx = "^0.28.1"          # Async HTTP
networkx = "^3.4.2"        # Dependency graph analysis
numpy = "^2.2.1"           # Numerical operations
sentence-transformers = "^3.3.1"  # Semantic similarity
prometheus-client = "^0.21.1"     # Metrics export
rich = "^13.9.4"           # CLI dashboard
typer = "^0.15.1"          # Modern CLI framework
pydantic = "^2.10.3"       # Config validation
pytest-asyncio = "^0.24.0" # Async tests
pytest-cov = "^6.0.0"      # Coverage
```

---

## Implementation Phases

### Phase 1: Foundation (Week 1-2)
- Add new dependencies
- Create `config/` module with Pydantic settings
- Implement YAML config loader with hot-reload
- Create `models/` module with shared dataclasses
- Extend CLI with `config` command

### Phase 2: Enhanced Discovery (Week 2-3)
- Extend `GitHubScanner` with language-specific queries
- Implement `RepoDiscoverer` with package registry APIs
- Add dependent count fetching from libraries.io
- Implement health score calculation

### Phase 3: Dependency Graph Analysis (Week 3-4)
- Implement `DependencyGraphAnalyzer` for Python
- Add PageRank and centrality calculations
- Extend to JS, Go, Rust
- Create impact score composite metric

### Phase 4: Issue Processing (Week 4-5)
- Implement `IssueFetcher`
- Create `llm/` module with Claude/OpenAI adapters
- Implement LLM-based issue categorization
- Add multi-factor priority scoring

### Phase 5: Budget Management (Week 5-6)
- Implement `BudgetManager` with persistent state
- Add token estimation
- Enforce per-repo and per-language limits

### Phase 6: Solution Generation (Week 6-7)
- Implement multi-step solution generation
- Add code generation prompts per language
- Implement test generation
- Add solution validation

### Phase 7: PR Automation (Week 7-8)
- Implement `PRAutomation` class
- Add auto-merge strategy
- Implement CI status monitoring

### Phase 8: Redundancy Detection (Week 8-9)
- Implement README embedding and similarity
- Add API signature comparison
- Generate archival recommendations

### Phase 9: Monitoring & Dashboard (Week 9-10)
- Implement `MetricsCollector`
- Create CLI dashboard with `rich`
- Add metrics export

### Phase 10: Integration & Testing (Week 10-12)
- End-to-end testing
- Pilot on single language
- Refine prompts based on results

---

## Budget Limits (Configurable)

```python
MAX_TOKENS_PER_REPO = 100_000
MAX_TIME_PER_REPO = 3600  # seconds
MAX_ISSUES_PER_LANGUAGE = 50
MAX_ISSUES_PER_REPO = 5
WEEKLY_TOKEN_BUDGET = 5_000_000
```

---

## Safety Rules for Auto-Merge

| Risk Level | Criteria | Action |
|------------|----------|--------|
| LOW | Complexity <= 3, internal code, tests exist | Enable auto-merge |
| MEDIUM | Complexity 4-5, minor API change | Auto-merge + notify |
| HIGH | Complexity 6-7, significant API change | Manual review |
| CRITICAL | Complexity >= 8, security, breaking | Do not automate |

---

## Configuration File Location

`~/.config/globallm/config.yaml` - All thresholds modifiable here

---

## Critical Files to Modify

1. `/mnt/f/Tom/Documents/GIT/globallm/pyproject.toml` - Add dependencies
2. `/mnt/f/Tom/Documents/GIT/globallm/src/globallm/cli.py` - Extend CLI
3. `/mnt/f/Tom/Documents/GIT/globallm/src/globallm/scanner.py` - Extend scanner
4. `/mnt/f/Tom/Documents/GIT/globallm/src/globallm/logging_config.py` - Add operation IDs

---

## New CLI Commands

```bash
globallm discover --language python --min-stars 1000
globallm analyze --repo django/django
globallm issues --repo django/django --max-issues 50
globallm prioritize --language python --top 100
globallm fix --issue-url <url> --dry-run
globallm budget --show
globallm config --show --set filter.min_stars=2000
globallm status --dashboard
globallm redundancy --language javascript
```

---

## Dashboard Preview

```
╭─────────────────────────────────────────────────────────────────╮
│                     GlobalLM Status Dashboard                    │
├─────────────────────────────────────────────────────────────────┤
│ Budget Used: 234,567 / 5,000,000 tokens (4.7%)                  │
│ ┌─────────────────────┬─────────┬──────────┬─────────┬────────┐ │
│ │ Repository          │ Issues  │ PRs      │ Merged  │ Impact │ │
│ ├─────────────────────┼─────────┼──────────┼─────────┼────────┤ │
│ │ django/django       │ 5       │ 3        │ 2       │ 98.5   │ │
│ └─────────────────────┴─────────┴──────────┴─────────┴────────┘ │
╰─────────────────────────────────────────────────────────────────╯
```
